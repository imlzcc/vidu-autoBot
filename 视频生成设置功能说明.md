# 视频生成设置功能说明

## 功能概述

在Vidu批量视频生成插件v3.0.0中新增了视频生成设置功能，允许用户在插件面板中直接控制视频生成的关键参数，包括宽高比、错峰模式和生成数量等。

## 主要特性

### 1. 宽高比选择
- **支持格式**: 9:16 (竖屏)、16:9 (横屏)、1:1 (正方形)、4:3 (传统)、3:4 (竖屏传统)
- **自动应用**: 切换到参考生视频模式时自动设置
- **智能识别**: 使用多种选择器策略识别页面控件

### 2. 错峰模式控制
- **可视化开关**: 美观的切换开关界面
- **状态保持**: 设置状态自动保存
- **自动应用**: 根据设置自动开启/关闭错峰模式

### 3. 生成数量设置
- **数量范围**: 支持1-4个视频的生成数量
- **灵活配置**: 可根据需要调整每次生成的数量
- **自动应用**: 自动设置到主网站的生成数量控件

### 4. 设置持久化
- **自动保存**: 所有设置自动保存到Chrome存储
- **状态恢复**: 下次使用时自动恢复上次的设置
- **跨会话保持**: 关闭浏览器后重新打开仍保持设置

## 技术实现

### 新增UI组件
```html
<!-- 视频生成设置区域 -->
<div class="vidu-video-settings-section">
    <div class="vidu-section-title">🎬 视频生成设置</div>
    <div class="vidu-setting-item">
        <span class="vidu-setting-label">宽高比:</span>
        <select class="vidu-mode-select" id="vidu-aspect-ratio">
            <option value="9:16">9:16 (竖屏)</option>
            <option value="16:9">16:9 (横屏)</option>
            <option value="1:1">1:1 (正方形)</option>
            <option value="4:3">4:3 (传统)</option>
            <option value="3:4">3:4 (竖屏传统)</option>
        </select>
    </div>
    <div class="vidu-setting-item">
        <span class="vidu-setting-label">错峰模式:</span>
        <label class="vidu-toggle-switch">
            <input type="checkbox" id="vidu-off-peak-mode" checked>
            <span class="vidu-toggle-slider"></span>
        </label>
        <span class="vidu-toggle-label">启用错峰模式避免系统负载过高</span>
    </div>
    <div class="vidu-setting-item">
        <span class="vidu-setting-label">生成数量:</span>
        <select class="vidu-mode-select" id="vidu-generation-count">
            <option value="1">1个</option>
            <option value="2">2个</option>
            <option value="3">3个</option>
            <option value="4">4个</option>
        </select>
    </div>
</div>
```

### 核心方法

#### 1. 设置应用方法
```javascript
async applyVideoSettings() {
    try {
        // 1. 设置宽高比
        await this.setAspectRatio(this.settings.aspectRatio);
        
        // 2. 设置错峰模式
        if (this.settings.offPeakMode) {
            await this.enableOffPeakMode();
        }
        
        // 3. 设置生成数量
        await this.setGenerationCount(this.settings.generationCount);
        
        this.logMessage(`已应用视频设置: 宽高比=${this.settings.aspectRatio}, 错峰模式=${this.settings.offPeakMode}, 数量=${this.settings.generationCount}`, 'success');
    } catch (error) {
        this.logMessage(`应用视频设置失败: ${error.message}`, 'error');
    }
}
```

#### 2. 宽高比设置方法
```javascript
async setAspectRatio(aspectRatio) {
    const aspectRatioSelectors = [
        'select[class*="aspect"]',
        'select[class*="ratio"]',
        'select option:contains("' + aspectRatio + '")',
        '[data-testid*="aspect"]',
        '[data-testid*="ratio"]'
    ];
    
    for (const selector of aspectRatioSelectors) {
        try {
            const element = this.deepQuerySelectorAll([selector]).find(el => {
                const text = el.textContent || el.innerText || '';
                return text.includes(aspectRatio) || text.includes('宽高比') || text.includes('比例');
            });
            
            if (element) {
                this.attemptClick(element);
                await this.sleep(500);
                this.logMessage(`已设置宽高比为: ${aspectRatio}`, 'success');
                return;
            }
        } catch (error) {
            continue;
        }
    }
    
    this.logMessage(`未找到宽高比设置控件，请手动设置`, 'warning');
}
```

#### 3. 生成数量设置方法
```javascript
async setGenerationCount(count) {
    const countSelectors = [
        'select[class*="count"]',
        'select[class*="quantity"]',
        'select[class*="number"]',
        'button[class*="count"]',
        '[data-testid*="count"]',
        '[data-testid*="quantity"]'
    ];
    
    for (const selector of countSelectors) {
        try {
            const elements = this.deepQuerySelectorAll([selector]);
            const element = elements.find(el => {
                const text = el.textContent || el.innerText || '';
                return text.includes(count.toString()) || text.includes('数量') || text.includes('个数');
            });
            
            if (element) {
                this.attemptClick(element);
                await this.sleep(500);
                this.logMessage(`已设置生成数量为: ${count}`, 'success');
                return;
            }
        } catch (error) {
            continue;
        }
    }
    
    this.logMessage(`未找到数量设置控件，请手动设置`, 'warning');
}
```

### CSS样式

#### 切换开关样式
```css
.vidu-toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 8px;
}

.vidu-toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.vidu-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.vidu-toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.vidu-toggle-switch input:checked + .vidu-toggle-slider {
    background-color: #4CAF50;
}

.vidu-toggle-switch input:checked + .vidu-toggle-slider:before {
    transform: translateX(26px);
}
```

## 使用方法

### 1. 配置设置
1. 打开Vidu图生视频页面
2. 点击悬浮球图标打开插件面板
3. 在"视频生成设置"区域中调整参数：
   - 选择宽高比（如9:16竖屏）
   - 开启/关闭错峰模式
   - 设置生成数量（如2个）

### 2. 应用设置
1. 点击"🎯 参考生视频"按钮
2. 插件会自动应用所有设置到主网站
3. 检查主网站的设置是否正确应用

### 3. 开始生成
1. 输入批量提示词
2. 点击"开始处理"按钮
3. 插件会使用您设置的参数进行批量生成

## 注意事项

1. **控件识别**: 插件使用多种策略识别页面控件，如果无法找到会显示警告
2. **版本兼容**: 不同版本的Vidu网站界面可能有差异
3. **手动设置**: 如果自动设置失败，需要手动在主网站设置
4. **设置保存**: 所有设置会自动保存，下次使用时无需重新设置

## 版本信息

- 版本：v3.0.0
- 新增功能：视频生成设置
- 兼容性：Chrome 88+, Edge 88+
- 依赖：Vidu平台设置控件
